name: iOS TestFlight External

# Reusable workflow for submitting to external TestFlight beta review
# Submits an existing build for external beta review and tags it in git

on:
  workflow_call:
    inputs:
      bundle_id:
        description: 'App bundle identifier'
        required: true
        type: string
      build_number:
        description: 'Build number to submit (leave empty for latest)'
        required: false
        type: string
        default: ''
      whats_new:
        description: 'What''s new in this build (for testers)'
        required: false
        type: string
        default: 'Bug fixes and improvements.'
    outputs:
      build_number:
        description: 'The build number submitted'
        value: ${{ jobs.submit-external.outputs.build_number }}
    secrets:
      APP_STORE_CONNECT_KEY_ID:
        required: true
      APP_STORE_CONNECT_ISSUER_ID:
        required: true
      APP_STORE_CONNECT_PRIVATE_KEY:
        required: true

jobs:
  submit-external:
    name: Submit for External Beta Review
    runs-on: ubuntu-latest
    outputs:
      build_number: ${{ steps.submit.outputs.build_number }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup App Store Connect API Key
      run: |
        mkdir -p ~/.private_keys
        echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" > ~/.private_keys/AuthKey.p8
        chmod 600 ~/.private_keys/AuthKey.p8

    - name: Install dependencies
      run: pip3 install PyJWT cryptography

    - name: Submit for External Review & Tag
      id: submit
      env:
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_BUNDLE_ID: ${{ inputs.bundle_id }}
      run: |
        JWT=$(python3 -c "
        import jwt, time, os
        k = os.environ['APP_STORE_CONNECT_KEY_ID']
        i = os.environ['APP_STORE_CONNECT_ISSUER_ID']
        print(jwt.encode({
          'iss': i,
          'iat': int(time.time()),
          'exp': int(time.time()) + 1200,
          'aud': 'appstoreconnect-v1'
        }, open(os.path.expanduser('~/.private_keys/AuthKey.p8')).read(),
        algorithm='ES256', headers={'kid': k}))
        ")

        # Get app ID
        APP_RESPONSE=$(curl -g -s -H "Authorization: Bearer $JWT" \
          "https://api.appstoreconnect.apple.com/v1/apps?filter[bundleId]=$APP_BUNDLE_ID")
        APP_ID=$(echo "$APP_RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin)['data'][0]['id'])")
        echo "App ID: $APP_ID"

        # Get build
        BUILD_FILTER="${{ inputs.build_number }}"
        if [ -n "$BUILD_FILTER" ]; then
          BUILDS_URL="https://api.appstoreconnect.apple.com/v1/builds?filter[app]=$APP_ID&filter[version]=$BUILD_FILTER"
        else
          BUILDS_URL="https://api.appstoreconnect.apple.com/v1/builds?filter[app]=$APP_ID&sort=-version&limit=1"
        fi

        BUILDS_RESPONSE=$(curl -g -s -H "Authorization: Bearer $JWT" "$BUILDS_URL")

        BUILD_INFO=$(echo "$BUILDS_RESPONSE" | python3 -c "
        import sys, json
        data = json.load(sys.stdin)
        builds = data.get('data', [])
        if builds:
          b = builds[0]
          print(f\"{b['id']}|{b['attributes']['version']}\")
        ")

        BUILD_ID=$(echo "$BUILD_INFO" | cut -d'|' -f1)
        BUILD_VERSION=$(echo "$BUILD_INFO" | cut -d'|' -f2)

        if [ -z "$BUILD_ID" ]; then
          echo "ERROR: No build found"
          exit 1
        fi

        echo "Submitting build $BUILD_VERSION (ID: $BUILD_ID) for external review..."
        echo "build_number=$BUILD_VERSION" >> $GITHUB_OUTPUT

        # Add beta build localization
        curl -g -s -X POST \
          -H "Authorization: Bearer $JWT" \
          -H "Content-Type: application/json" \
          -d "{\"data\":{\"type\":\"betaBuildLocalizations\",\"attributes\":{\"locale\":\"en-US\",\"whatsNew\":\"${{ inputs.whats_new }}\"},\"relationships\":{\"build\":{\"data\":{\"type\":\"builds\",\"id\":\"$BUILD_ID\"}}}}}" \
          "https://api.appstoreconnect.apple.com/v1/betaBuildLocalizations" || true

        # Submit for beta review
        REVIEW_RESPONSE=$(curl -g -s -w "\n%{http_code}" -X POST \
          -H "Authorization: Bearer $JWT" \
          -H "Content-Type: application/json" \
          -d "{\"data\":{\"type\":\"betaAppReviewSubmissions\",\"relationships\":{\"build\":{\"data\":{\"type\":\"builds\",\"id\":\"$BUILD_ID\"}}}}}" \
          "https://api.appstoreconnect.apple.com/v1/betaAppReviewSubmissions")

        HTTP_CODE=$(echo "$REVIEW_RESPONSE" | tail -n1)
        if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "409" ]; then
          echo "Build submitted for external beta review!"
        else
          echo "Review submission returned HTTP $HTTP_CODE"
        fi

    - name: Create Git Tag
      run: |
        BUILD="${{ steps.submit.outputs.build_number }}"
        TAG="testflight_build_$BUILD"

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git tag -a "$TAG" -m "TestFlight external build $BUILD

        Submitted for external beta review.
        What's new: ${{ inputs.whats_new }}

        Triggered by: ${{ github.actor }}"

        git push origin "$TAG"
        echo "Created tag: $TAG"

    - name: Summary
      run: |
        echo "## External TestFlight Submission" >> $GITHUB_STEP_SUMMARY
        echo "- **Bundle ID**: ${{ inputs.bundle_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build**: ${{ steps.submit.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Git Tag**: testflight_build_${{ steps.submit.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: Submitted for external beta review" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "Run **App Store Release** workflow to prepare for App Store submission" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup
      if: always()
      run: rm -rf ~/.private_keys
